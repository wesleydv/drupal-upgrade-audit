#!/usr/bin/php
<?php

require __DIR__ . '/vendor/autoload.php';

use wesleydv\DrupalUpgradeAudit\Version;
use wesleydv\DrupalUpgradeAudit\Complexity;
use wesleydv\DrupalUpgradeAudit\Compatibility;

$base_dir = '/tmp';
$result = [];
$project = $argv[1];

// Check if drupal check is available.
if (!`which drupal-check`) {
    pl('drupal-check command not found, please install it globally https://github.com/mglaman/drupal-check#installation');
    exit(1);
}

$dir = $base_dir . '/' . $project;
if (is_dir($dir)) {
	pl("# You already have the code, fancy, fetching and checking out master");
	chdir($dir);
	`git fetch --quiet`;
	`git checkout --quiet master`;
}
else {
    echo "# Cloning the code, you know like Dolly";
	chdir($base_dir);
	`git clone --quiet git@git.dropsolid.com:project/$project.git`;
	chdir($dir);
}

pl('# Looking up Drupal versions');
addResult('Original Drupal version: ' . Version::getInitialDrupalVersion());

pl('# Assessing complexity');
addResult(sprintf('There are %s custom modules and %s lines of custom code', Complexity::getCustomModules(), Complexity::getCustomCodeLines()));

// Check compatibility modules
pl('# Checking compatibility, this might take a while');
$compatibility = new Compatibility();
$compatibility->run();
addResult($compatibility->getSummary());

// Run drupal-check
pl("# Looking for deprecated code");
$check_results_file = $dir . '-check.txt';
`drupal-check docroot/modules/custom &> $check_results_file`;
$check_results = file_get_contents($check_results_file);
if (preg_match('/\[OK\]/', $check_results)) {
    addResult('Drupal check: Found no errors, make sure you check ' . $check_results_file . ' for details');
}
if (preg_match('/Found (\d+) errors/', $check_results, $num_errors)) {
    $num_errors = $num_errors[1];
    addResult('Drupal check: Found ' . $num_errors . ' errors, check ' . $check_results_file . ' for details');
}

pl();
pl('##########################################################');
pl();
foreach ($result as $line) {
    pl($line);
    pl();
}
pl('##########################################################');
pl();


/**
 * Write to screen.
 */
function pl($str = '') {
    echo $str . PHP_EOL;
}

function addResult($str) {
    global $result;
    $result[] = $str;
}
